services:
  # ============================================
  # 1) NGINX — React 정적 페이지 + API Reverse Proxy
  # ============================================
  nginx:
    container_name: routepick-nginx
    image: nginx:stable
    restart: always
    ports:
      - "80:80"        # Cloudflare가 443 관리 → EC2에는 80만 열면 됨
    volumes:
      - ../board-front/build:/usr/share/nginx/html                    # React 빌드 결과
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf             # 우리가 만든 reverse proxy 설정
    depends_on:
      - backend
    networks:
      - routepick-net

  # ============================================
  # 2) SPRING BOOT BACKEND
  # ============================================
  backend:
    container_name: routepick-backend
    build:
      context: ../board-back
      dockerfile: Dockerfile           # 멀티 스테이지 Dockerfile (prod 용)
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: prod     # prod 프로필 활성화
      TZ: Asia/Seoul
    env_file:
      - ./env/prod.env                 # DB 비밀번호, API Key 등
    volumes:
      - /home/ubuntu/app/fileUpload:/home/ubuntu/app/fileUpload       # 리눅스 파일 경로 고정
    depends_on:
      - db
    networks:
      - routepick-net

  # ============================================
  # 3) MYSQL Database
  # ============================================
  db:
    container_name: routepick-mysql
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_DATABASE: board
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - routepick-net

# ============================================
# NETWORK
# ============================================
networks:
  routepick-net:

# ============================================
# VOLUMES
# ============================================
volumes:
  mysql-data:
